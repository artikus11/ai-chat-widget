/**
 * –ü—Ä–∞–≤–∏–ª–æ –¥–ª—è –ø–æ–∫–∞–∑–∞ –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º, –∫–æ—Ç–æ—Ä—ã–µ –≤–µ—Ä–Ω—É–ª–∏—Å—å –Ω–∞ —Å–∞–π—Ç —Å–ø—É—Å—Ç—è 2‚Äì10 –º–∏–Ω—É—Ç –ø–æ—Å–ª–µ
 * –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –ø–æ—Å–µ—â–µ–Ω–∏—è, –Ω–æ –Ω–µ –æ—Ç–ø—Ä–∞–≤–ª—è–ª–∏ —Å–æ–æ–±—â–µ–Ω–∏—è –≤ —á–∞—Ç.
 *
 * –£—Å–ª–æ–≤–∏—è:
 * 1. –¢–∏–ø 'returning' —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –≤ –ø—Ä–æ–≤–∞–π–¥–µ—Ä–µ —Å–æ–æ–±—â–µ–Ω–∏–π.
 * 2. –°–æ–æ–±—â–µ–Ω–∏–µ —ç—Ç–æ–≥–æ —Ç–∏–ø–∞ —Ä–∞–Ω–µ–µ –Ω–µ –ø–æ–∫–∞–∑—ã–≤–∞–ª–æ—Å—å (–ø—Ä–æ–≤–µ—Ä–∫–∞ —á–µ—Ä–µ–∑ TipStorage).
 * 3. –ù–µ –¥–µ–π—Å—Ç–≤—É–µ—Ç –∫—É–ª–¥–∞—É–Ω –Ω–∞ –ø–æ–∫–∞–∑ —ç—Ç–æ–≥–æ —Ç–∏–ø–∞ —Å–æ–æ–±—â–µ–Ω–∏–π (–ø—Ä–æ–≤–µ—Ä–∫–∞ —á–µ—Ä–µ–∑ TipCooldown).
 * 4. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ—Ç–∫—Ä—ã–≤–∞–ª —á–∞—Ç —Ä–∞–Ω–µ–µ (lastChatOpenTime !== null).
 * 5. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –æ—Ç–ø—Ä–∞–≤–ª—è–ª —Å–æ–æ–±—â–µ–Ω–∏—è –≤ —á–∞—Ç (hasSentMessage === false).
 * 6. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–µ—Ä–Ω—É–ª—Å—è –Ω–∞ —Å–∞–π—Ç —Å–ø—É—Å—Ç—è 2‚Äì10 –º–∏–Ω—É—Ç –ø–æ—Å–ª–µ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –ø–æ—Å–µ—â–µ–Ω–∏—è (isRecentlyReturned === true).
 *
 * –ï—Å–ª–∏ –≤—Å–µ —É—Å–ª–æ–≤–∏—è –≤—ã–ø–æ–ª–Ω–µ–Ω—ã, –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç—Å—è —Ç–∏–ø 'returning' –¥–ª—è –ø–æ–∫–∞–∑–∞ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–µ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è.
 * –í –ø—Ä–æ—Ç–∏–≤–Ω–æ–º —Å–ª—É—á–∞–µ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç—Å—è null.
 */
export const ReturningRule = {
    /**
     * –ü—Ä–æ–≤–µ—Ä—è–µ—Ç, —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç –ª–∏ —Ç–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —É—Å–ª–æ–≤–∏—è–º –¥–ª—è –ø–æ–∫–∞–∑–∞ –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è.
     *
     * @param {Object} state - –°–æ—Å—Ç–æ—è–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
     * @param {number|null} state.lastChatOpenTime - –í—Ä–µ–º–µ–Ω–Ω–∞—è –º–µ—Ç–∫–∞ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –æ—Ç–∫—Ä—ã—Ç–∏—è —á–∞—Ç–∞ (timestamp), –∏–ª–∏ `null`, –µ—Å–ª–∏ –Ω–∏–∫–æ–≥–¥–∞.
     * @param {boolean} state.hasSentMessage - –§–ª–∞–≥, —É–∫–∞–∑—ã–≤–∞—é—â–∏–π, –æ—Ç–ø—Ä–∞–≤–ª—è–ª –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å–æ–æ–±—â–µ–Ω–∏–µ.
     * @param {boolean} state.isRecentlyReturned - –§–ª–∞–≥, —É–∫–∞–∑—ã–≤–∞—é—â–∏–π, –≤–µ—Ä–Ω—É–ª—Å—è –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤ –¥–∏–∞–ø–∞–∑–æ–Ω–µ 2‚Äì10 –º–∏–Ω—É—Ç.
     * @param {DecisionEngine} engine - –≠–∫–∑–µ–º–ø–ª—è—Ä –¥–≤–∏–∂–∫–∞ –ø—Ä–∏–Ω—è—Ç–∏—è —Ä–µ—à–µ–Ω–∏–π, —Å–æ–¥–µ—Ä–∂–∞—â–∏–π –ø—Ä–æ–≤–∞–π–¥–µ—Ä —Å–æ–æ–±—â–µ–Ω–∏–π –∏ –≤—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Å–µ—Ä–≤–∏—Å—ã.
     * @param {Object} context - –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–π –∫–æ–Ω—Ç–µ–∫—Å—Ç, –∫–æ—Ç–æ—Ä—ã–π –º–æ–∂–µ—Ç –±—ã—Ç—å –ø–æ–ª–µ–∑–µ–Ω –¥–ª—è –ø—Ä–∞–≤–∏–ª (–Ω–∞–ø—Ä–∏–º–µ—Ä, 'outer' –∏–ª–∏ 'inner').
     * @returns {string|null} –¢–∏–ø —Å–æ–æ–±—â–µ–Ω–∏—è –¥–ª—è –ø–æ–∫–∞–∑–∞ ('welcome') –∏–ª–∏ `null`, –µ—Å–ª–∏ —É—Å–ª–æ–≤–∏—è –Ω–µ –≤—ã–ø–æ–ª–Ω–µ–Ω—ã.
     */
    matches(state, engine, context) {
        const { lastChatOpenTime, hasSentMessage, isRecentlyReturned } = state;
        const { storage, cooldown } = engine.helpers;

        const type = 'returning';
        const category = 'out';

        // 1. –ï—Å—Ç—å –ª–∏ –≤–æ–æ–±—â–µ —Ç–∞–∫–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ?
        if (!engine.has(type, category)) {
            return null;
        }

        // 2. –£–∂–µ –ø–æ–∫–∞–∑—ã–≤–∞–ª–∏ returning?
        if (storage.wasShown(type, category)) {
            return null;
        }

        // 3. –ü—Ä–æ—à—ë–ª –ª–∏ –∫—É–ª–¥–∞—É–Ω?
        if (!cooldown.canShow(type, category)) {
            return null;
        }

        // 4. –û—Å–Ω–æ–≤–Ω—ã–µ —É—Å–ª–æ–≤–∏—è –ø–æ –¥–µ–π—Å—Ç–≤–∏—é
        if (lastChatOpenTime === null) {
            return null; // –ù–µ –æ—Ç–∫—Ä—ã–≤–∞–ª —á–∞—Ç
        }

        if (hasSentMessage) {
            return null; // –£–∂–µ –ø–∏—Å–∞–ª ‚Äî –Ω–µ –Ω—É–∂–¥–∞–µ—Ç—Å—è
        }

        if (!isRecentlyReturned) {
            return null; // –ù–µ –≤ –¥–∏–∞–ø–∞–∑–æ–Ω–µ 2‚Äì10 –º–∏–Ω
        }

        // üîë 5. –ë—ã–ª –ª–∏ –ø–æ–∫–∞–∑–∞–Ω welcome? (–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ–µ —É—Å–ª–æ–≤–∏–µ)
        if (!storage.wasShown('welcome', category)) {
            return null; // –ï—â—ë –Ω–µ –≤–∏–¥–µ–ª –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ ‚Äî —Å–Ω–∞—á–∞–ª–∞ welcome
        }

        // üîë 6. –ï—Å–ª–∏ –µ—Å—Ç—å followup, –Ω–æ –µ–≥–æ –µ—â—ë –Ω–µ –ø–æ–∫–∞–∑—ã–≤–∞–ª–∏ ‚Äî –Ω–µ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º returning
        if (
            engine.has('followup', category) &&
            !storage.wasShown('followup', category)
        ) {
            return null;
        }

        // ‚úÖ –í—Å–µ —É—Å–ª–æ–≤–∏—è –≤—ã–ø–æ–ª–Ω–µ–Ω—ã
        return type;
    },
};
