/**
 * Правило для показа приветственного сообщения, если пользователь
 * ещё не открывал чат и не отправлял сообщения.
 *
 * Логика:
 * - Если нет шаблона такого сообщения — не показываем
 * - Если уже показывали это сообщение — не показываем
 * - Если кулдаун не позволяет показать — не показываем
 * - Если пользователь уже открывал чат — не показываем
 * - Если пользователь уже отправил сообщение — не показываем
 * - Иначе показываем.
 */
export const WelcomeRule = {
    /**
     * Проверяет, соответствует ли текущее состояние пользователя условиям для показа приветственного сообщения.
     *
     * @param {Object} state - Состояние пользователя
     * @param {number|null} state.lastChatOpenTime - Временная метка последнего открытия чата (timestamp), или `null`, если никогда.
     * @param {boolean} state.hasSentMessage - Флаг, указывающий, отправлял ли пользователь сообщение.
     * @param {Object} context - Дополнительный контекст, который может быть полезен для правил (например, 'outer' или 'inner').
     * @param {DecisionEngine} engine - Экземпляр движка принятия решений, содержащий провайдер сообщений и вспомогательные сервисы.
     * @returns {string|null} Тип сообщения для показа ('welcome') или `null`, если условия не выполнены.
     */
    matches(state, engine, context) {
        const { lastChatOpenTime, hasSentMessage } = state;
        const { storage, cooldown } = engine.helpers;

        const messageType = 'welcome';
        const messageCategory = 'out'; // например, исходящее системное сообщение

        // Проверяем: существует ли такое сообщение?
        if (!engine.has(messageType, messageCategory)) {
            return null; // нет шаблона — не показываем
        }

        // Проверяем кулдаун (например, не показывать чаще раза в 24 часа)
        if (!cooldown.canShow(messageType, messageCategory)) {
            return null;
        }

        // Пользователь уже открывал чат? Тогда уже поздно с приветом
        if (lastChatOpenTime !== null) {
            return null; // чат уже открывали — не показываем
        }

        // Пользователь уже отправил сообщение? Тоже поздно
        if (hasSentMessage) {
            return null; // уже писал — значит, начал общение
        }

        return messageType;
    },
};
